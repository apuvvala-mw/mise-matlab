#!/usr/bin/env bash
set -e

MATLAB_VERSION="$1"
INSTALL_DIR="$2"
TOOLBOXES="$3" # Comma-separated, e.g., "MATLAB,Signal_Processing_Toolbox"

# Detect OS and set MPM download URL
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
  MPM_URL="https://www.mathworks.com/mpm/glnxa64/mpm"
  MPM_BIN="mpm"
elif [[ "$OSTYPE" == "darwin"* ]]; then
  # Mac (Intel or Apple Silicon)
  ARCH=$(uname -m)
  if [[ "$ARCH" == "arm64" ]]; then
    MPM_URL="https://www.mathworks.com/mpm/maca64/mpm"
  else
    MPM_URL="https://www.mathworks.com/mpm/maci64/mpm"
  fi
  MPM_BIN="mpm"
elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "win32" ]]; then
  MPM_URL="https://www.mathworks.com/mpm/win64/mpm"
  MPM_BIN="mpm.exe"
else
  echo "Unsupported OS: $OSTYPE"
  exit 1
fi

# Download MPM if not present
if ! command -v mpm &> /dev/null; then
  echo "MPM not found. Downloading..."
  curl -L -o "$MPM_BIN" "$MPM_URL"
  chmod +x "$MPM_BIN"
  export PATH="$PWD:$PATH"
fi

# Prepare the MPM install command
$MPM_BIN install \
  --release="${MATLAB_VERSION}" \
  --destination="${INSTALL_DIR}" \
  --products="${TOOLBOXES}"

echo "MATLAB ${MATLAB_VERSION} with toolboxes [${TOOLBOXES}] installed at ${INSTALL_DIR}"
